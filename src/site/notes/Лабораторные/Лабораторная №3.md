---
{"dg-publish":true,"permalink":"/laboratornye/laboratornaya-3/"}
---


## Начало работы с AppArmor

### 1. Проверка _complain_ и _enforce_ режимов

**1.1. Создайте копию утилиты `ping` (из директории `/bin/`), а вместо нее скопируйте утилиту `cp` (`/bin/cp -> /bin/ping`). После этого переведите профиль `bin.ping` в режим `enforce`. Создайте в домашней директории файл и попробуйте его скопировать с помощью утилиты `ping` (которая, по факту, является копией утилиты `cp`).**
![Pasted image 20250610155607.png](/img/user/Pasted%20image%2020250610155607.png)
- Сохраняем оригинальный `ping`
- Подменяем `ping` на `cp`
- Переводим профиль `ping` в режим `enforce`
- Создаём тестовый файл
- Пытаемся скопировать с помощью `ping` (на самом деле `cp`)

Объясните, что произошло. Посмотрите журнал, что там за сообщения (относительно этой операции), что они значат?
![Pasted image 20250610155932.png](/img/user/Pasted%20image%2020250610155932.png)
- AppArmor в режиме enforce блокирует любые действия, не разрешённые в профиле.
- Поскольку `ping` не должен читать произвольные пользовательские файлы, `cp` (запущенный под видом `ping`) нарушает политику.

**1.2. Переведите профиль `bin.ping` в режим `complain`. Повторите действия из шага 1.1. Что изменилось? Объясните. Какие теперь записи в журнале?**
![Pasted image 20250610160545.png](/img/user/Pasted%20image%2020250610160545.png)
- Переводим в режим `complain`
- `cp` выполнило копирование

![Pasted image 20250610160915.png](/img/user/Pasted%20image%2020250610160915.png)
- В режиме **complain** AppArmor фиксирует нарушения профиля, но не препятствует работе программы.

**1.3. Верните утилиту `ping` на свое место.**
![Pasted image 20250610161448.png](/img/user/Pasted%20image%2020250610161448.png)
- Восстанавливаем оригинальный ping

**1.4. Переведите профиль `bin.ping` в режим `enforce`. Попробуйте воспользоваться утилитов (из шага 1.1.) `my_ping`.**
![Pasted image 20250610163129.png](/img/user/Pasted%20image%2020250610163129.png)
- До этого использовал mv, соответственно логично использовать исходный ping
![Pasted image 20250610163403.png](/img/user/Pasted%20image%2020250610163403.png)
Если снова попробуем заменить `ping` на `cp` - тот же результат, что и в п. 1.1

### 2. AppArmor на примере Docker

**2.1. Установите Docker**
Ранее docker уже был установлен у меня в рабочем пространстве Ubuntu, поэтому париться с установкой не пришлось. Сразу создаем группу `docker` и добавляем туда себя.
![Pasted image 20250619003555.png](/img/user/Pasted%20image%2020250619003555.png)
![Pasted image 20250619003607.png](/img/user/Pasted%20image%2020250619003607.png)

**2.2. Создайте Docker-конетейнер с ubuntu:**
![Pasted image 20250619004145.png](/img/user/Pasted%20image%2020250619004145.png)
Создали контейнер.
![Pasted image 20250619004209.png](/img/user/Pasted%20image%2020250619004209.png)
Проверили, кто мы там)
![Pasted image 20250619004340.png](/img/user/Pasted%20image%2020250619004340.png)
Вышли, проверяем какой профиль AppArmor загружен. `-enforce`

Создайте два новых каталога (внутри контейнера), смонтируйте первый каталог в другой каталог (подробнее, `mount --bind`)
![Pasted image 20250619004649.png](/img/user/Pasted%20image%2020250619004649.png)
Создали
![Pasted image 20250619004828.png](/img/user/Pasted%20image%2020250619004828.png)
mount `--bind` не дает смонтировать один каталог в другой

![Pasted image 20250619005315.png](/img/user/Pasted%20image%2020250619005315.png)
Почему-то `CAP_SYSLOG` не помог исправить ситуацию

![Pasted image 20250619005734.png](/img/user/Pasted%20image%2020250619005734.png)
Нашел ошибку, исправил ввод, все сработало

### 3. Пользовательский профиль AppArmor
**3.1. Скачайте материалы для ЛР из репозитория Docker:**
![Pasted image 20250619010213.png](/img/user/Pasted%20image%2020250619010213.png)

**3.2. Опишите, какие контейнеры предлагается создать (docker-compose.yml). Создайте контейнеры с помощью docker-compose**
![Pasted image 20250619010322.png](/img/user/Pasted%20image%2020250619010322.png)
Именно docker-compose.yml запускает контейнеры `wordpress` и `mysql`

![Pasted image 20250619010917.png](/img/user/Pasted%20image%2020250619010917.png)
Запуск не увенчался успехом -> поменяем через `nano`

![Pasted image 20250619011251.png](/img/user/Pasted%20image%2020250619011251.png)
Поменяли

![Pasted image 20250619011453.png](/img/user/Pasted%20image%2020250619011453.png)
УСПЕШНО!

**3.3. Проверьте работоспособность WordPress, выбрав язык и установив какие-либо плагины.**

![Pasted image 20250619011648.png](/img/user/Pasted%20image%2020250619011648.png)
Запускаем http://localhost:80/

![Pasted image 20250619012258.png](/img/user/Pasted%20image%2020250619012258.png)
Не запустилось, перезапустил, не помогло

Пробую сменить версию на "3"
![Pasted image 20250619012626.png](/img/user/Pasted%20image%2020250619012626.png)
Успешно, проблема была в том, что Firefox автоматически перекидывал соединение на https

![Pasted image 20250619012943.png](/img/user/Pasted%20image%2020250619012943.png)
Залогинился, перехожу во вкладку плагины.


![Pasted image 20250619013102.png](/img/user/Pasted%20image%2020250619013102.png)
Успешно добавляем любые плагины.

**3.4. Удалите созданные контейнеры.**
![Pasted image 20250619013349.png](/img/user/Pasted%20image%2020250619013349.png)

**3.5. Добавьте wparmor профиль в файл конфигурации.**

![Pasted image 20250619014000.png](/img/user/Pasted%20image%2020250619014000.png)
![Pasted image 20250619013905.png](/img/user/Pasted%20image%2020250619013905.png)
Вставил:
``` Bash
security_opt:
    - apparmor=wparmor
```


![Pasted image 20250619014042.png](/img/user/Pasted%20image%2020250619014042.png)

Основные правила wparmor
**Ограничения на /proc:**
 - Запрещена запись в большинство директорий /proc, кроме допустимых:
 - Только shm* в /proc/sys/kernel/ разрешено.
 - Запрещены чувствительные файлы: /proc/mem, /proc/kmem, /proc/kcore, /proc/sysrq-trigger.

**Запрет монтирования:**
 - Запрещены команды mount и umount, чтобы контейнер не мог подключать файловые системы.

**Ограничения на /sys:**
Запрещена запись и выполнение в большинстве подпапок /sys, включая:
 - /sys/fs/ (кроме cgroup)
 - /sys/firmware/efi/efivars/
 - /sys/kernel/security/

**Запрет модификации WordPress:**
Запрещена запись и выполнение в ключевых директориях WordPress:
 - /var/www/html/
 - /var/www/html/wp-admin/
 - /var/www/html/wp-includes/
 - /var/www/html/wp-content/ (только верхний уровень)

**Безопасность процессов и сигналов:**
 - Разрешено ptrace (трассировка) между контейнерами — нужно для docker ps и ps.
 - Разрешён приём сигналов от демона Docker (kill, term) — важно для нормального управления контейнерами.

**3.6. Отредактируйте файл wparmor так, чтобы запретить использование каталогов в `var/www/html/wp-content` за исключением директории `uploads`. _Спарсите_ новый файл (`apparmor_parse`).**
![Pasted image 20250619015023.png](/img/user/Pasted%20image%2020250619015023.png)

Помещаем профиль wparmor в директорию `/etc/apparmor.d/`
![Pasted image 20250619015334.png](/img/user/Pasted%20image%2020250619015334.png)

![Pasted image 20250619015655.png](/img/user/Pasted%20image%2020250619015655.png)
Проверяем с помощью команды `aa-status`, что wparmor запущен в enforce режиме

**3.7. Повторите шаги 3.2. и 3.3. и опишите результат.**
![Pasted image 20250619020310.png](/img/user/Pasted%20image%2020250619020310.png)
не запускается

перезаписал `docker_compose.yml`, в нем были ошибки
**Итог:**
![Pasted image 20250619021543.png](/img/user/Pasted%20image%2020250619021543.png)

**Можете ли вы устанавливать плагины и загружать другой контент?**

Не могу, потому что конфигурация профиля `wparmor` запрещает запись и изменение объектов в каталоге `/wp-content` и `/wp-admin`.
